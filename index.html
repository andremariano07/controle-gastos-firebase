<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle 2026 - Gastos</title>

  <style>
    :root{
      --bg:#f3dcc6; --panel:#f7e6d6; --line:#d8b79c;
      --blue:#2b67c9; --blue2:#1f56b3; --text:#1c1c1c; --muted:#6b5a4f;
      --radius:14px;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:18px auto; padding:0 14px 40px; }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
      flex-wrap: wrap;
    }
    .month{
      font-family:"Brush Script MT","Comic Sans MS",cursive;
      font-size:56px; line-height:1; margin:0;
      min-width:240px;
    }
    .small{ font-size:12px; color:var(--muted); }
    .saldoBox{
      flex:1; min-width:260px;
      display:flex; align-items:center; justify-content:center; gap:16px;
      background:var(--blue); color:#fff; border-radius:12px; padding:10px 14px; min-height:54px;
    }
    .saldoBox .label{ font-weight:800; letter-spacing:.4px; }
    .saldoBox .value{ font-weight:900; font-size:18px; }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    select, input, button{
      padding:10px; border-radius:10px; border:1px solid var(--line);
      background:#fff; font-size:14px;
    }
    button{ cursor:pointer; background:var(--blue2); color:#fff; border:none; }
    button:hover{ filter:brightness(1.05); }
    .ghost{ background:#fff; color:var(--blue2); border:1px solid var(--blue2); }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr 1.2fr 1.35fr;
      gap:14px;
      align-items:start;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
    }
    .cardTitle{
      margin:0 0 10px;
      font-size:14px; letter-spacing:.4px; text-transform:uppercase;
      color:var(--muted); font-weight:900;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ flex:1; min-width:210px; }
    .field label{ display:block; font-size:12px; color:var(--muted); font-weight:800; margin:0 0 6px; }
    .field input{ width:100%; box-sizing:border-box; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      background:#fff; border:1px solid var(--line); border-radius:12px;
      padding:10px;
    }
    .kpi .t{ font-size:12px; color:var(--muted); font-weight:800; }
    .kpi .v{ font-size:18px; font-weight:900; margin-top:4px; }

    .totLine{
      display:flex; justify-content:space-between; align-items:center;
      margin-top:10px; padding-top:10px; border-top:1px dashed var(--line);
      font-weight:900;
    }

    .chartBox{
      background:#fff; border:1px solid var(--line); border-radius:12px;
      padding:12px;
    }

    .status{
      margin-top:8px;
      padding:8px 10px;
      background:#fff; border:1px solid var(--line); border-radius:12px;
      font-size:12px; color:var(--muted);
    }

    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .month{ font-size:44px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="display:none; min-height:100vh; background:var(--bg);">
    <div style="max-width:420px; margin:0 auto; padding:28px 14px;">
      <div class="card">
        <p class="cardTitle">Entrar</p>

        <div class="field" style="margin-bottom:10px;">
          <label>E-mail</label>
          <input id="loginEmail" type="email" placeholder="seuemail@exemplo.com" autocomplete="email">
        </div>

        <div class="field" style="margin-bottom:10px;">
          <label>Senha</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnLogin">Entrar</button>
          <button id="btnRegister" class="ghost">Criar conta</button>
        </div>

        <div class="status" id="loginStatus" style="margin-top:10px;">Digite e-mail e senha.</div>

        <div class="row" style="margin-top:10px;">
          <button id="btnResendVerify" class="ghost" title="Se voc√™ j√° criou a conta, reenvie o e-mail de verifica√ß√£o.">
            Reenviar verifica√ß√£o
          </button>
        </div>

        <div class="small" style="margin-top:8px; line-height:1.45;">
          Ao criar conta, voc√™ precisa <b>confirmar o e-mail</b> antes de ativar o MFA.
        </div>
      </div>
    </div>
  </div>

  <!-- ENROLL MFA (primeira vez) -->
  <div id="enrollScreen" style="display:none; min-height:100vh; background:var(--bg);">
    <div style="max-width:420px; margin:0 auto; padding:28px 14px;">
      <div class="card">
        <p class="cardTitle">Ativar MFA (obrigat√≥rio)</p>

        <div class="small" style="line-height:1.5; margin-bottom:10px;">
          Para proteger sua conta, confirme um telefone (SMS). Use o formato internacional:
          <b>+5531999999999</b>
        </div>

        <div class="field" style="margin-bottom:10px;">
          <label>Telefone (com DDI)</label>
          <input id="enrollPhone" type="tel" placeholder="+55 31 99999-9999" autocomplete="tel">
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnEnrollSend">Enviar c√≥digo</button>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>C√≥digo SMS</label>
          <input id="enrollCode" type="text" inputmode="numeric" placeholder="123456" autocomplete="one-time-code">
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnEnrollVerify">Confirmar e continuar</button>
          <button id="btnEnrollLogout" class="ghost">Sair</button>
        </div>

        <div id="recaptcha-container" style="margin-top:10px;"></div>
        <div class="status" id="enrollStatus" style="margin-top:10px;">Informe seu telefone.</div>
      </div>
    </div>
  </div>

  <!-- MFA CHALLENGE (todo login quando MFA existir) -->
  <div id="mfaScreen" style="display:none; min-height:100vh; background:var(--bg);">
    <div style="max-width:420px; margin:0 auto; padding:28px 14px;">
      <div class="card">
        <p class="cardTitle">Verifica√ß√£o em 2 etapas</p>

        <div class="small" style="line-height:1.5; margin-bottom:10px;">
          Enviamos um c√≥digo SMS para o seu telefone. Digite abaixo:
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnMfaSend">Reenviar c√≥digo</button>
          <button id="btnMfaBack" class="ghost">Voltar</button>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>C√≥digo SMS</label>
          <input id="mfaCode" type="text" inputmode="numeric" placeholder="123456" autocomplete="one-time-code">
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnMfaVerify">Confirmar</button>
        </div>

        <div class="status" id="mfaStatus" style="margin-top:10px;">Aguardando‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- APP SCREEN -->
  <div id="appScreen" class="wrap" style="display:none;">
    <div class="topbar">
      <div>
        <h1 class="month" id="monthTitle">janeiro</h1>
        <div class="small">
          Ano: <b>2026</b> ‚Ä¢ Saldo final projetado = saldo em conta + (sal√°rio ‚àí (Inter + C6 + Seguro))
        </div>
      </div>

      <div class="saldoBox">
        <div class="label">SALDO FINAL (PROJETADO)</div>
        <div class="value">R$ <span id="saldoFinal">0,00</span></div>
      </div>

      <div class="controls">
        <select id="monthSelect"></select>
        <button id="resetBtn" class="ghost" title="S√≥ zera os campos do m√™s selecionado (n√£o apaga outros meses).">Zerar m√™s</button>
        <button id="logoutBtn" class="ghost">Sair</button>
      </div>
    </div>

    <div class="grid">

      <div class="card">
        <p class="cardTitle">Campos do m√™s</p>

        <div class="row">
          <div class="field">
            <label>Sal√°rio do m√™s (R$)</label>
            <input id="salario" type="text" inputmode="decimal" placeholder="R$ 3.500,00" autocomplete="off">
          </div>
          <div class="field">
            <label>Cart√£o Inter - fatura (R$)</label>
            <input id="inter" type="text" inputmode="decimal" placeholder="R$ 1.200,00" autocomplete="off">
          </div>
          <div class="field">
            <label>Cart√£o C6 - fatura (R$)</label>
            <input id="c6" type="text" inputmode="decimal" placeholder="R$ 800,00" autocomplete="off">
          </div>

          <div class="field">
            <label>Seguro do carro (R$)</label>
            <input id="seguroCarro" type="text" inputmode="decimal" placeholder="R$ 250,00" autocomplete="off">
          </div>

          <div class="field">
            <label>Quanto tenho na conta (R$)</label>
            <input id="saldoConta" type="text" inputmode="decimal" placeholder="R$ 500,00" autocomplete="off">
          </div>
        </div>

        <div class="status" id="status">Aguardando login‚Ä¶</div>

        <div style="margin-top:12px" class="kpis">
          <div class="kpi">
            <div class="t">Total Sa√≠das (Inter + C6 + Seguro)</div>
            <div class="v">R$ <span id="totalCartoes">0,00</span></div>
          </div>
          <div class="kpi">
            <div class="t">Sobra do Sal√°rio (Sal√°rio ‚àí Sa√≠das)</div>
            <div class="v">R$ <span id="sobraSalario">0,00</span></div>
          </div>
          <div class="kpi" style="grid-column: 1 / -1;">
            <div class="t">Saldo Final Projetado (Saldo em conta + Sobra do sal√°rio)</div>
            <div class="v">R$ <span id="saldoFinal2">0,00</span></div>
          </div>
        </div>

        <div class="totLine">
          <div>Resumo r√°pido</div>
          <div id="quickHint" class="small"></div>
        </div>

        <!-- TABELA DO QUE EST√Å SALVO -->
        <div style="margin-top:15px;">
          <p class="cardTitle">Dados Salvos no Firebase (M√™s Atual)</p>

          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden;">
              <thead style="background:#f0d8c2;">
                <tr>
                  <th style="padding:8px; border:1px solid #d8b79c; text-align:left;">Campo</th>
                  <th style="padding:8px; border:1px solid #d8b79c; text-align:left;">Valor</th>
                </tr>
              </thead>
              <tbody id="dadosSalvosTabela"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <p class="cardTitle">Como o gr√°fico funciona</p>

        <div class="small" style="line-height:1.55">
          <b>Barras (12 meses):</b><br>
          ‚Ä¢ <b>Sal√°rio</b> (positivo)<br>
          ‚Ä¢ <b>Sa√≠das (Inter + C6 + Seguro)</b> (mostrado como valor positivo, mas representa ‚Äúsa√≠da‚Äù)<br><br>

          <b>Linha (12 meses):</b><br>
          ‚Ä¢ <b>Saldo Final Projetado</b> = saldo em conta + (sal√°rio ‚àí sa√≠das)<br><br>

          Assim voc√™ enxerga f√°cil:
          <ul>
            <li>se as sa√≠das (cart√µes + seguro) est√£o consumindo muito do sal√°rio</li>
            <li>se o saldo final projetado est√° subindo ou caindo ao longo de 2026</li>
          </ul>
        </div>

        <div class="small" style="margin-top:10px">
          Dica: preencha m√™s a m√™s (Jan‚Ä¶Dez). O gr√°fico se atualiza automaticamente.
        </div>
      </div>

      <div class="card">
        <p class="cardTitle">Gr√°fico 2026</p>
        <div class="chartBox">
          <canvas id="chart" height="120"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      setPersistence,
      browserSessionPersistence,

      // ‚úÖ email verification helpers
      sendEmailVerification,
      reload,

      // ‚úÖ MFA (SMS)
      PhoneAuthProvider,
      RecaptchaVerifier,
      multiFactor,
      PhoneMultiFactorGenerator,
      getMultiFactorResolver
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOZap1gB8N8k-3-4nhA-jd2k7HlFJgIes",
      authDomain: "gastos-92e20.firebaseapp.com",
      projectId: "gastos-92e20",
      storageBucket: "gastos-92e20.firebasestorage.app",
      messagingSenderId: "248552638302",
      appId: "1:248552638302:web:0588762093eaf4108d31cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    await setPersistence(auth, browserSessionPersistence);

    const $ = (id) => document.getElementById(id);

    // ====== Screen Router ======
    function showOnly(screenId){
      const screens = ["loginScreen","enrollScreen","mfaScreen","appScreen"];
      screens.forEach(id => {
        const el = $(id);
        if (!el) return;
        el.style.display = (id === screenId) ? "block" : "none";
      });
    }
    function showLogin(msg){
      showOnly("loginScreen");
      $("loginStatus").textContent = msg || "Digite e-mail e senha.";
    }
    function showEnroll(msg){
      showOnly("enrollScreen");
      $("enrollStatus").textContent = msg || "Informe seu telefone.";
    }
    function showMfa(msg){
      showOnly("mfaScreen");
      $("mfaStatus").textContent = msg || "Aguardando‚Ä¶";
    }
    function showApp(){
      showOnly("appScreen");
    }

    // ====== MFA (reCAPTCHA) ======
    let recaptchaVerifier = null;
    function ensureRecaptcha(){
      if (recaptchaVerifier) return recaptchaVerifier;
      recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
        size: "invisible"
      });
      return recaptchaVerifier;
    }

    let enrollVerificationId = null;
    let mfaResolver = null;
    let mfaVerificationId = null;

    async function sendMfaCode(){
      const verifier = ensureRecaptcha();
      const phoneAuthProvider = new PhoneAuthProvider(auth);
      const hint = mfaResolver.hints[0];
      mfaVerificationId = await phoneAuthProvider.verifyPhoneNumber(
        { multiFactorHint: hint, session: mfaResolver.session },
        verifier
      );
    }

    // ====== Moeda BR ======
    function brl(n){
      const s = (Number(n)||0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
      return s.replace(/\u00A0/g, " ");
    }
    function brNum(n){
      return (Number(n)||0).toLocaleString("pt-BR",{ minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    function parseBRL(value){
      if (value == null) return 0;
      let s = String(value).trim();
      if (!s) return 0;
      s = s.replace(/\s/g,"").replace(/^R\$/i,"");
      s = s.replace(/[^\d,.\-]/g, "");
      if (s.includes(",")){
        s = s.replace(/\./g,"").replace(",",".");
      }
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function formatInputToBRL(el){
      const n = parseBRL(el.value);
      el.value = brl(n);
    }

    // ====== Prote√ß√£o anti "embolar n√∫meros" ======
    const editing = new Set();
    function markEditing(el, isOn){
      if (!el) return;
      if (isOn) editing.add(el.id);
      else editing.delete(el.id);
    }
    function safeSetInput(id, value){
      const el = $(id);
      if (!el) return;
      if (editing.has(id)) return;
      el.value = brl(value);
    }

    const months = Array.from({length:12}, (_,i)=> {
      const m = String(i+1).padStart(2,"0");
      return `2026-${m}`;
    });
    const monthNames = ["janeiro","fevereiro","mar√ßo","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];

    months.forEach((id, i) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = `${monthNames[i]} / 2026`;
      $("monthSelect").appendChild(opt);
    });

    const now = new Date();
    const defaultMonth = (now.getFullYear() === 2026) ? `2026-${String(now.getMonth()+1).padStart(2,"0")}` : "2026-01";
    $("monthSelect").value = defaultMonth;
    $("monthTitle").textContent = monthNames[months.indexOf($("monthSelect").value)];

    let uid = null;
    let unsubSelected = null;
    let unsubAllMonths = null;

    const monthsData = new Map(months.map(m => [m, { salario:0, inter:0, c6:0, seguroCarro:0, saldoConta:0 }]));
    let chart = null;

    // ====== AUTO SAVE ======
    let autosaveTimer = null;
    let autosaveInFlight = false;
    let pendingSaveAfter = false;

    function calcFields(d){
      const salario = parseBRL(d.salario);
      const inter = parseBRL(d.cartaoInter ?? d.inter);
      const c6 = parseBRL(d.cartaoC6 ?? d.c6);
      const seguroCarro = parseBRL(d.seguroCarro);
      const saldoConta = parseBRL(d.saldoConta);

      const totalSaidas = inter + c6 + seguroCarro;
      const sobraSalario = salario - totalSaidas;
      const saldoFinal = saldoConta + sobraSalario;

      return { salario, inter, c6, seguroCarro, saldoConta, totalSaidas, sobraSalario, saldoFinal };
    }

    function updateKPIs(d){
      const c = calcFields(d);

      $("totalCartoes").textContent = brNum(c.totalSaidas);
      $("sobraSalario").textContent = brNum(c.sobraSalario);
      $("saldoFinal").textContent = brNum(c.saldoFinal);
      $("saldoFinal2").textContent = brNum(c.saldoFinal);

      if (c.sobraSalario >= 0) {
        $("quickHint").textContent = `Sobrou ${brl(c.sobraSalario)} do sal√°rio; somando com a conta, saldo final projeta ${brl(c.saldoFinal)}.`;
      } else {
        $("quickHint").textContent = `Sa√≠das passaram ${brl(Math.abs(c.sobraSalario))} do sal√°rio; seu saldo final projeta ${brl(c.saldoFinal)}.`;
      }
    }

    function atualizarTabelaSalvos(d, updatedAtMillis = null){
      const c = calcFields(d);
      const tbody = $("dadosSalvosTabela");
      if (!tbody) return;

      const updatedText = updatedAtMillis
        ? new Date(updatedAtMillis).toLocaleString("pt-BR")
        : "-";

      const linhas = [
        ["Sal√°rio", brl(c.salario)],
        ["Cart√£o Inter", brl(c.inter)],
        ["Cart√£o C6", brl(c.c6)],
        ["Seguro Carro", brl(c.seguroCarro)],
        ["Saldo em Conta", brl(c.saldoConta)],
        ["Total Sa√≠das", brl(c.totalSaidas)],
        ["Sobra do Sal√°rio", brl(c.sobraSalario)],
        ["Saldo Final Projetado", brl(c.saldoFinal)],
        ["√öltima Atualiza√ß√£o", updatedText]
      ];

      tbody.innerHTML = "";
      linhas.forEach(([campo, valor]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:8px; border:1px solid #d8b79c;">${campo}</td>
          <td style="padding:8px; border:1px solid #d8b79c; font-weight:900;">${valor}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function setInputsFromDoc(d){
      safeSetInput("salario", d.salario);
      safeSetInput("inter", d.cartaoInter ?? d.inter);
      safeSetInput("c6", d.cartaoC6 ?? d.c6);
      safeSetInput("seguroCarro", d.seguroCarro);
      safeSetInput("saldoConta", d.saldoConta);

      updateKPIs(d);

      const updatedAtMillis = d?.updatedAt?.toMillis?.() ?? null;
      atualizarTabelaSalvos(d, updatedAtMillis);
    }

    function currentMonthId(){ return $("monthSelect").value; }
    function monthDocRef(monthId){ return doc(db, "users", uid, "months", monthId); }

    async function ensureMonthDocsExist(){
      for (const m of months){
        const ref = monthDocRef(m);
        const snap = await getDoc(ref);
        if (!snap.exists()){
          await setDoc(ref, {
            salario: 0,
            cartaoInter: 0,
            cartaoC6: 0,
            seguroCarro: 0,
            saldoConta: 0,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }
      }
    }

    function rebuildChart(){
      const labels = months.map(m => monthNames[months.indexOf(m)].slice(0,3).toUpperCase());

      const salarios = months.map(m => calcFields({
        ...monthsData.get(m),
        cartaoInter: monthsData.get(m).cartaoInter ?? monthsData.get(m).inter,
        cartaoC6: monthsData.get(m).cartaoC6 ?? monthsData.get(m).c6
      }).salario);

      const saidas = months.map(m => calcFields({
        ...monthsData.get(m),
        cartaoInter: monthsData.get(m).cartaoInter ?? monthsData.get(m).inter,
        cartaoC6: monthsData.get(m).cartaoC6 ?? monthsData.get(m).c6
      }).totalSaidas);

      const saldoFinal = months.map(m => calcFields({
        ...monthsData.get(m),
        cartaoInter: monthsData.get(m).cartaoInter ?? monthsData.get(m).inter,
        cartaoC6: monthsData.get(m).cartaoC6 ?? monthsData.get(m).c6
      }).saldoFinal);

      const ctx = $("chart");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Sal√°rio", data: salarios, borderWidth: 1 },
            { label: "Sa√≠das (Inter + C6 + Seguro)", data: saidas, borderWidth: 1 },
            {
              label: "Saldo Final Projetado",
              data: saldoFinal,
              type: "line",
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 3,
              yAxisID: "y"
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${brl(ctx.parsed.y)}` } }
          },
          scales: { y: { ticks: { callback: (v) => brl(v) } } }
        }
      });
    }

    function listenAllMonths(){
      const colRef = collection(db, "users", uid, "months");
      unsubAllMonths = onSnapshot(colRef, (snap) => {
        snap.forEach(docSnap => {
          const monthId = docSnap.id;
          if (!monthsData.has(monthId)) return;
          const d = docSnap.data() || {};
          monthsData.set(monthId, {
            salario: parseBRL(d.salario),
            cartaoInter: parseBRL(d.cartaoInter),
            cartaoC6: parseBRL(d.cartaoC6),
            seguroCarro: parseBRL(d.seguroCarro),
            saldoConta: parseBRL(d.saldoConta)
          });
        });
        rebuildChart();
      });
    }

    function listenSelectedMonth(){
      if (unsubSelected) unsubSelected();

      const m = currentMonthId();
      $("monthTitle").textContent = monthNames[months.indexOf(m)];

      const ref = monthDocRef(m);
      unsubSelected = onSnapshot(ref, (snap) => {
        if (!snap.exists()){
          const empty = {salario:0, cartaoInter:0, cartaoC6:0, seguroCarro:0, saldoConta:0};
          setInputsFromDoc(empty);
          $("status").textContent = `Carregado: ${m} ‚Ä¢ (vazio)`;
          return;
        }
        const d = snap.data() || {};
        setInputsFromDoc(d);
        $("status").textContent = `Carregado: ${m} ‚Ä¢ √öltima atualiza√ß√£o: ok`;
      });
    }

    async function saveCurrentMonthAuto(reason = "auto"){
      if (!uid) return;

      const m = currentMonthId();
      const ref = monthDocRef(m);

      const payload = {
        salario: parseBRL($("salario").value),
        cartaoInter: parseBRL($("inter").value),
        cartaoC6: parseBRL($("c6").value),
        seguroCarro: parseBRL($("seguroCarro").value),
        saldoConta: parseBRL($("saldoConta").value),
        updatedAt: serverTimestamp()
      };

      if (autosaveInFlight) { pendingSaveAfter = true; return; }

      autosaveInFlight = true;
      try{
        $("status").textContent = "Salvando‚Ä¶";
        await setDoc(ref, payload, { merge: true });
        updateKPIs(payload);
        atualizarTabelaSalvos(payload, Date.now());
        $("status").textContent = `Salvo automaticamente: ${m}`;
      } catch (e){
        console.error(e);
        $("status").textContent = "Falha ao salvar. Verifique sua internet e tente novamente.";
      } finally {
        autosaveInFlight = false;
        if (pendingSaveAfter) { pendingSaveAfter = false; scheduleAutosave("pending"); }
      }
    }

    function scheduleAutosave(reason = "typing"){
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => saveCurrentMonthAuto(reason), 1500);
    }

    async function resetCurrentMonth(){
      const m = currentMonthId();
      const ref = monthDocRef(m);

      const payload = {
        salario: 0,
        cartaoInter: 0,
        cartaoC6: 0,
        seguroCarro: 0,
        saldoConta: 0,
        updatedAt: serverTimestamp()
      };

      await setDoc(ref, payload, { merge: true });
      $("status").textContent = `Zerado: ${m}`;

      updateKPIs(payload);
      atualizarTabelaSalvos(payload, Date.now());
      ["salario","inter","c6","seguroCarro","saldoConta"].forEach(id => safeSetInput(id, 0));
    }

    $("monthSelect").addEventListener("change", () => listenSelectedMonth());
    $("resetBtn").addEventListener("click", resetCurrentMonth);

    const moneyFields = ["salario","inter","c6","seguroCarro","saldoConta"];
    moneyFields.forEach(id => {
      const el = $(id);
      el.addEventListener("focus", () => markEditing(el, true));
      el.addEventListener("input", () => {
        el.value = el.value.replace(/[^\d,.\-R$\s]/g, "");
        const draft = {
          salario: $("salario").value,
          cartaoInter: $("inter").value,
          cartaoC6: $("c6").value,
          seguroCarro: $("seguroCarro").value,
          saldoConta: $("saldoConta").value
        };
        updateKPIs(draft);
        atualizarTabelaSalvos(draft, null);
        scheduleAutosave("input");
      });
      el.addEventListener("blur", () => {
        markEditing(el, false);
        formatInputToBRL(el);
        saveCurrentMonthAuto("blur");
      });
    });

    function formatAllInputsNow(){
      moneyFields.forEach(id => {
        const el = $(id);
        if (!el || !el.value || editing.has(id)) return;
        formatInputToBRL(el);
      });
    }

    window.addEventListener("beforeunload", () => { saveCurrentMonthAuto("unload"); });

    // ====== AUTH ======
    $("btnLogin").addEventListener("click", async () => {
      try{
        $("loginStatus").textContent = "Entrando‚Ä¶";
        await signInWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPass").value);
      } catch(e){
        console.error(e);

        if (e.code === "auth/multi-factor-auth-required"){
          mfaResolver = getMultiFactorResolver(auth, e);
          showMfa("Enviando c√≥digo SMS‚Ä¶");
          try{
            await sendMfaCode();
            $("mfaStatus").textContent = "C√≥digo enviado. Digite o SMS.";
          } catch(err){
            console.error(err);
            $("mfaStatus").textContent = "Falha ao enviar SMS: " + (err.code || err.message);
          }
          return;
        }

        $("loginStatus").textContent = "Erro ao entrar: " + (e.code || e.message);
      }
    });

    $("btnRegister").addEventListener("click", async () => {
      try{
        $("loginStatus").textContent = "Criando conta‚Ä¶";
        const cred = await createUserWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPass").value);
        await sendEmailVerification(cred.user);
        $("loginStatus").textContent = "Conta criada ‚úÖ Verifique seu e-mail e fa√ßa login.";
        await signOut(auth);
      } catch(e){
        console.error(e);
        $("loginStatus").textContent = "Erro ao criar conta: " + (e.code || e.message);
      }
    });

    $("btnResendVerify").addEventListener("click", async () => {
      try{
        const email = $("loginEmail").value.trim();
        const pass = $("loginPass").value;

        if (!email || !pass){
          $("loginStatus").textContent = "Preencha e-mail e senha para reenviar a verifica√ß√£o.";
          return;
        }

        $("loginStatus").textContent = "Reenviando verifica√ß√£o‚Ä¶";
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await sendEmailVerification(cred.user);
        $("loginStatus").textContent = "Enviado ‚úÖ Verifique seu e-mail e depois fa√ßa login.";
        await signOut(auth);
      } catch(e){
        console.error(e);
        $("loginStatus").textContent = "Erro ao reenviar: " + (e.code || e.message);
      }
    });

    $("logoutBtn").addEventListener("click", async () => { await signOut(auth); });

    // MFA screen
    $("btnMfaSend").addEventListener("click", async () => {
      try{
        if (!mfaResolver) return showLogin("Fa√ßa login novamente.");
        $("mfaStatus").textContent = "Enviando c√≥digo SMS‚Ä¶";
        await sendMfaCode();
        $("mfaStatus").textContent = "C√≥digo enviado. Digite o SMS.";
      } catch(e){
        console.error(e);
        $("mfaStatus").textContent = "Erro ao reenviar: " + (e.code || e.message);
      }
    });

    $("btnMfaVerify").addEventListener("click", async () => {
      try{
        $("mfaStatus").textContent = "Confirmando‚Ä¶";
        const code = $("mfaCode").value.trim();

        if (!mfaResolver || !mfaVerificationId || !code){
          $("mfaStatus").textContent = "Reenvie o c√≥digo e preencha o SMS.";
          return;
        }

        const cred = PhoneAuthProvider.credential(mfaVerificationId, code);
        const assertion = PhoneMultiFactorGenerator.assertion(cred);

        await mfaResolver.resolveSignIn(assertion);
        $("mfaStatus").textContent = "Ok ‚úÖ Entrando‚Ä¶";
      } catch(e){
        console.error(e);
        $("mfaStatus").textContent = "C√≥digo inv√°lido/expirado: " + (e.code || e.message);
      }
    });

    $("btnMfaBack").addEventListener("click", () => {
      mfaResolver = null;
      mfaVerificationId = null;
      showLogin("Digite e-mail e senha.");
    });

    // Enroll screen
    $("btnEnrollLogout").addEventListener("click", async () => { await signOut(auth); });

    $("btnEnrollSend").addEventListener("click", async () => {
      try{
        $("enrollStatus").textContent = "Enviando SMS‚Ä¶";

        const user = auth.currentUser;
        if (!user) return showLogin("Fa√ßa login novamente.");

        const phoneNumber = $("enrollPhone").value.trim();
        if (!phoneNumber || !phoneNumber.startsWith("+")){
          $("enrollStatus").textContent = "Use DDI no formato: +5531999999999";
          return;
        }

        const verifier = ensureRecaptcha();
        const session = await multiFactor(user).getSession();

        const phoneAuthProvider = new PhoneAuthProvider(auth);
        enrollVerificationId = await phoneAuthProvider.verifyPhoneNumber(
          { phoneNumber, session },
          verifier
        );

        $("enrollStatus").textContent = "C√≥digo enviado. Digite o SMS e confirme.";
      } catch(e){
        console.error(e);
        $("enrollStatus").textContent = "Erro ao enviar SMS: " + (e.code || e.message);
      }
    });

    $("btnEnrollVerify").addEventListener("click", async () => {
      try{
        $("enrollStatus").textContent = "Confirmando‚Ä¶";

        const user = auth.currentUser;
        if (!user) return showLogin("Fa√ßa login novamente.");

        const code = $("enrollCode").value.trim();
        if (!enrollVerificationId || !code) {
          $("enrollStatus").textContent = "Envie o c√≥digo primeiro e preencha o SMS.";
          return;
        }

        const cred = PhoneAuthProvider.credential(enrollVerificationId, code);
        const assertion = PhoneMultiFactorGenerator.assertion(cred);

        await multiFactor(user).enroll(assertion, "Telefone");
        $("enrollStatus").textContent = "MFA ativado ‚úÖ Carregando‚Ä¶";

        showApp();
        $("status").textContent = "Inicializando meses de 2026‚Ä¶";
        await ensureMonthDocsExist();
        $("status").textContent = "Pronto ‚úÖ";
        listenAllMonths();
        listenSelectedMonth();
        setTimeout(formatAllInputsNow, 50);

      } catch(e){
        console.error(e);
        $("enrollStatus").textContent = "Erro ao confirmar: " + (e.code || e.message);
      }
    });

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (unsubAllMonths) { unsubAllMonths(); unsubAllMonths = null; }
      if (unsubSelected) { unsubSelected(); unsubSelected = null; }

      if (!user){
        uid = null;
        showLogin("Fa√ßa login para acessar seus dados.");
        return;
      }

      // üîí for√ßa atualizar estado e exigir e-mail verificado
      await reload(user);
      if (!user.emailVerified){
        showLogin("Verifique seu e-mail (link de confirma√ß√£o) e fa√ßa login novamente.");
        await signOut(auth);
        return;
      }

      uid = user.uid;

      // ‚úÖ exige MFA cadastrado
      const hasMfa = (user.multiFactor?.enrolledFactors?.length || 0) > 0;
      if (!hasMfa){
        showEnroll("Ative o MFA para continuar.");
        return;
      }

      showApp();

      try{
        $("status").textContent = "Inicializando meses de 2026‚Ä¶";
        await ensureMonthDocsExist();
        $("status").textContent = "Pronto ‚úÖ";
        listenAllMonths();
        listenSelectedMonth();
        setTimeout(formatAllInputsNow, 50);
      } catch(e){
        console.error(e);
        $("status").textContent = "Erro ao carregar dados. Veja o console (F12).";
      }
    });

    showLogin("Verificando sess√£o‚Ä¶");
  </script>
</body>
</html>
