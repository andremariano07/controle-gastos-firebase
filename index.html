<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle 2026 - Gastos</title>

  <style>
    :root{
      --bg:#f3dcc6; --panel:#f7e6d6; --line:#d8b79c;
      --blue:#2b67c9; --blue2:#1f56b3; --text:#1c1c1c; --muted:#6b5a4f;
      --radius:14px;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:18px auto; padding:0 14px 40px; }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
      flex-wrap: wrap;
    }
    .month{
      font-family:"Brush Script MT","Comic Sans MS",cursive;
      font-size:56px; line-height:1; margin:0;
      min-width:240px;
    }
    .small{ font-size:12px; color:var(--muted); }
    .saldoBox{
      flex:1; min-width:260px;
      display:flex; align-items:center; justify-content:center; gap:16px;
      background:var(--blue); color:#fff; border-radius:12px; padding:10px 14px; min-height:54px;
    }
    .saldoBox .label{ font-weight:800; letter-spacing:.4px; }
    .saldoBox .value{ font-weight:900; font-size:18px; }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    select, input, button{
      padding:10px; border-radius:10px; border:1px solid var(--line);
      background:#fff; font-size:14px;
    }
    button{ cursor:pointer; background:var(--blue2); color:#fff; border:none; }
    button:hover{ filter:brightness(1.05); }
    .ghost{ background:#fff; color:var(--blue2); border:1px solid var(--blue2); }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr 1.2fr 1.35fr;
      gap:14px;
      align-items:start;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
    }
    .cardTitle{
      margin:0 0 10px;
      font-size:14px; letter-spacing:.4px; text-transform:uppercase;
      color:var(--muted); font-weight:900;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ flex:1; min-width:210px; }
    .field label{ display:block; font-size:12px; color:var(--muted); font-weight:800; margin:0 0 6px; }
    .field input{ width:100%; box-sizing:border-box; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      background:#fff; border:1px solid var(--line); border-radius:12px;
      padding:10px;
    }
    .kpi .t{ font-size:12px; color:var(--muted); font-weight:800; }
    .kpi .v{ font-size:18px; font-weight:900; margin-top:4px; }

    .totLine{
      display:flex; justify-content:space-between; align-items:center;
      margin-top:10px; padding-top:10px; border-top:1px dashed var(--line);
      font-weight:900;
    }

    .chartBox{
      background:#fff; border:1px solid var(--line); border-radius:12px;
      padding:12px;
    }

    .status{
      margin-top:8px;
      padding:8px 10px;
      background:#fff; border:1px solid var(--line); border-radius:12px;
      font-size:12px; color:var(--muted);
      word-break: break-word;
    }

    .secretBox{
      background:#fff; border:1px dashed var(--line); border-radius:12px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
    }

    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .month{ font-size:44px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- QRCode: usamos fallback; se este CDN falhar, o sistema continua pela chave -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginScreen" style="display:none; min-height:100vh; background:var(--bg);">
    <div style="max-width:440px; margin:0 auto; padding:28px 14px;">
      <div class="card">
        <p class="cardTitle">Entrar</p>

        <div class="field" style="margin-bottom:10px;">
          <label>E-mail</label>
          <input id="loginEmail" type="email" placeholder="seuemail@exemplo.com" autocomplete="email">
        </div>

        <div class="field" style="margin-bottom:10px;">
          <label>Senha</label>
          <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnLogin">Entrar</button>
          <button id="btnRegister" class="ghost">Criar conta</button>
        </div>

        <div class="status" id="loginStatus" style="margin-top:10px;">Digite e-mail e senha.</div>

        <div class="row" style="margin-top:10px;">
          <button id="btnResendVerify" class="ghost">Reenviar verificação</button>
        </div>

        <div class="small" style="margin-top:8px; line-height:1.45;">
          Este modo usa <b>TOTP manual</b> (Authenticator) sem MFA do Firebase.
          <br><b>Obs:</b> para criar a conta, o e-mail precisa ser confirmado.
        </div>
      </div>
    </div>
  </div>

  <!-- ENROLL TOTP (manual) -->
  <div id="enrollScreen" style="display:none; min-height:100vh; background:var(--bg);">
    <div style="max-width:520px; margin:0 auto; padding:28px 14px;">
      <div class="card">
        <p class="cardTitle">Ativar MFA (Google Authenticator) — modo manual</p>

        <div class="small" style="line-height:1.55; margin-bottom:10px;">
          1) Clique em <b>Gerar QR</b><br>
          2) No Google Authenticator, adicione uma conta e escaneie o QR (ou use a chave)<br>
          3) Digite o código de 6 dígitos e confirme
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnTotpGenerate">Gerar QR</button>
          <button id="btnEnrollLogout" class="ghost">Sair</button>
        </div>

        <div style="margin-top:12px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
          <div style="background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px;">
            <canvas id="qrCanvas" width="180" height="180" style="display:block;"></canvas>
            <div class="small" style="margin-top:6px;">Escaneie o QR (ou use a chave)</div>
          </div>

          <div style="flex:1; min-width:240px;">
            <div class="small" style="margin-bottom:6px;"><b>Chave (se não puder escanear):</b></div>
            <div id="secretKeyBox" class="secretBox">—</div>
            <div class="small" style="margin-top:8px;">
              Guarde com cuidado. Não compartilhe.
              <br><b>Nota:</b> este modo é “manual” (não é MFA oficial do Firebase).
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:12px;">
          <label>Código do Authenticator</label>
          <input id="totpCode" type="text" inputmode="numeric" placeholder="123456" autocomplete="one-time-code">
        </div>

        <div class="row" style="margin-top:6px;">
          <button id="btnTotpVerify">Confirmar e continuar</button>
        </div>

        <div class="status" id="enrollStatus" style="margin-top:10px;">
          Clique em <b>Gerar QR</b> para iniciar.
        </div>
      </div>
    </div>
  </div>

  <!-- CHALLENGE TOTP (manual) -->
  <div id="mfaScreen" style="display:none; min-height:100vh; background:var(--bg);">
    <div style="max-width:460px; margin:0 auto; padding:28px 14px;">
      <div class="card">
        <p class="cardTitle">Verificação (Authenticator)</p>

        <div class="small" style="line-height:1.5; margin-bottom:10px;">
          Digite o código do Google Authenticator para continuar.
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Código (6 dígitos)</label>
          <input id="mfaCode" type="text" inputmode="numeric" placeholder="123456" autocomplete="one-time-code">
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnMfaVerify">Confirmar</button>
          <button id="btnMfaBack" class="ghost">Sair</button>
        </div>

        <div class="status" id="mfaStatus" style="margin-top:10px;">Aguardando…</div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appScreen" class="wrap" style="display:none;">
    <div class="topbar">
      <div>
        <h1 class="month" id="monthTitle">janeiro</h1>
        <div class="small">
          Ano: <b>2026</b> • Saldo final projetado = saldo em conta + (salário − (Inter + C6 + Seguro))
        </div>
      </div>

      <div class="saldoBox">
        <div class="label">SALDO FINAL (PROJETADO)</div>
        <div class="value">R$ <span id="saldoFinal">0,00</span></div>
      </div>

      <div class="controls">
        <select id="monthSelect"></select>
        <button id="resetBtn" class="ghost" title="Só zera os campos do mês selecionado (não apaga outros meses).">Zerar mês</button>
        <button id="logoutBtn" class="ghost">Sair</button>
      </div>
    </div>

    <div class="grid">

      <div class="card">
        <p class="cardTitle">Campos do mês</p>

        <div class="row">
          <div class="field">
            <label>Salário do mês (R$)</label>
            <input id="salario" type="text" inputmode="decimal" placeholder="R$ 3.500,00" autocomplete="off">
          </div>
          <div class="field">
            <label>Cartão Inter - fatura (R$)</label>
            <input id="inter" type="text" inputmode="decimal" placeholder="R$ 1.200,00" autocomplete="off">
          </div>
          <div class="field">
            <label>Cartão C6 - fatura (R$)</label>
            <input id="c6" type="text" inputmode="decimal" placeholder="R$ 800,00" autocomplete="off">
          </div>

          <div class="field">
            <label>Seguro do carro (R$)</label>
            <input id="seguroCarro" type="text" inputmode="decimal" placeholder="R$ 250,00" autocomplete="off">
          </div>

          <div class="field">
            <label>Quanto tenho na conta (R$)</label>
            <input id="saldoConta" type="text" inputmode="decimal" placeholder="R$ 500,00" autocomplete="off">
          </div>
        </div>

        <div class="status" id="status">Aguardando login…</div>

        <div style="margin-top:12px" class="kpis">
          <div class="kpi">
            <div class="t">Total Saídas (Inter + C6 + Seguro)</div>
            <div class="v">R$ <span id="totalCartoes">0,00</span></div>
          </div>
          <div class="kpi">
            <div class="t">Sobra do Salário (Salário − Saídas)</div>
            <div class="v">R$ <span id="sobraSalario">0,00</span></div>
          </div>
          <div class="kpi" style="grid-column: 1 / -1;">
            <div class="t">Saldo Final Projetado (Saldo em conta + Sobra do salário)</div>
            <div class="v">R$ <span id="saldoFinal2">0,00</span></div>
          </div>
        </div>

        <div class="totLine">
          <div>Resumo rápido</div>
          <div id="quickHint" class="small"></div>
        </div>

        <div style="margin-top:15px;">
          <p class="cardTitle">Dados Salvos no Firebase (Mês Atual)</p>
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden;">
              <thead style="background:#f0d8c2;">
                <tr>
                  <th style="padding:8px; border:1px solid #d8b79c; text-align:left;">Campo</th>
                  <th style="padding:8px; border:1px solid #d8b79c; text-align:left;">Valor</th>
                </tr>
              </thead>
              <tbody id="dadosSalvosTabela"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <p class="cardTitle">Como o gráfico funciona</p>
        <div class="small" style="line-height:1.55">
          <b>Barras (12 meses):</b><br>
          • <b>Salário</b> (positivo)<br>
          • <b>Saídas (Inter + C6 + Seguro)</b> (mostrado como valor positivo, mas representa “saída”)<br><br>

          <b>Linha (12 meses):</b><br>
          • <b>Saldo Final Projetado</b> = saldo em conta + (salário − saídas)<br><br>

          Assim você enxerga fácil:
          <ul>
            <li>se as saídas (cartões + seguro) estão consumindo muito do salário</li>
            <li>se o saldo final projetado está subindo ou caindo ao longo de 2026</li>
          </ul>
        </div>
        <div class="small" style="margin-top:10px">
          Dica: preencha mês a mês (Jan…Dez). O gráfico se atualiza automaticamente.
        </div>
      </div>

      <div class="card">
        <p class="cardTitle">Gráfico 2026</p>
        <div class="chartBox">
          <canvas id="chart" height="120"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, setPersistence, browserSessionPersistence,
      sendEmailVerification, reload
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOZap1gB8N8k-3-4nhA-jd2k7HlFJgIes",
      authDomain: "gastos-92e20.firebaseapp.com",
      projectId: "gastos-92e20",
      storageBucket: "gastos-92e20.firebasestorage.app",
      messagingSenderId: "248552638302",
      appId: "1:248552638302:web:0588762093eaf4108d31cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    await setPersistence(auth, browserSessionPersistence);

    const $ = (id) => document.getElementById(id);

    // ===== Screen router =====
    function showOnly(id){
      ["loginScreen","enrollScreen","mfaScreen","appScreen"].forEach(x=>{
        const el = $(x); if (!el) return;
        el.style.display = (x===id) ? "block" : "none";
      });
    }
    function showLogin(msg){ showOnly("loginScreen"); $("loginStatus").textContent = msg || "Digite e-mail e senha."; }
    function showEnroll(msg){ showOnly("enrollScreen"); $("enrollStatus").textContent = msg || "Configure o Authenticator."; }
    function showMfa(msg){ showOnly("mfaScreen"); $("mfaStatus").textContent = msg || "Digite o código do Authenticator."; }
    function showApp(){ showOnly("appScreen"); }

    // ===== BRL helpers =====
    function brl(n){
      const s = (Number(n)||0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
      return s.replace(/\u00A0/g, " ");
    }
    function brNum(n){
      return (Number(n)||0).toLocaleString("pt-BR",{ minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    function parseBRL(value){
      if (value == null) return 0;
      let s = String(value).trim();
      if (!s) return 0;
      s = s.replace(/\s/g,"").replace(/^R\$/i,"");
      s = s.replace(/[^\d,.\-]/g, "");
      if (s.includes(",")) s = s.replace(/\./g,"").replace(",",".");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function formatInputToBRL(el){
      const n = parseBRL(el.value);
      el.value = brl(n);
    }

    // ===== Anti "embolar" =====
    const editing = new Set();
    function markEditing(el, on){ if(on) editing.add(el.id); else editing.delete(el.id); }
    function safeSetInput(id, value){
      const el = $(id);
      if (!el) return;
      if (editing.has(id)) return;
      el.value = brl(value);
    }

    // ===== Months =====
    const months = Array.from({length:12}, (_,i)=> `2026-${String(i+1).padStart(2,"0")}`);
    const monthNames = ["janeiro","fevereiro","março","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];

    months.forEach((id, i) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = `${monthNames[i]} / 2026`;
      $("monthSelect").appendChild(opt);
    });

    const now = new Date();
    const defaultMonth = (now.getFullYear() === 2026) ? `2026-${String(now.getMonth()+1).padStart(2,"0")}` : "2026-01";
    $("monthSelect").value = defaultMonth;
    $("monthTitle").textContent = monthNames[months.indexOf($("monthSelect").value)];

    // ===== Firestore state =====
    let uid = null;
    let unsubSelected = null;
    let unsubAllMonths = null;
    const monthsData = new Map(months.map(m => [m, { salario:0, inter:0, c6:0, seguroCarro:0, saldoConta:0 }]));
    let chart = null;

    // ===== Autosave =====
    let autosaveTimer = null;
    let autosaveInFlight = false;
    let pendingSaveAfter = false;

    function calcFields(d){
      const salario = parseBRL(d.salario);
      const inter = parseBRL(d.cartaoInter ?? d.inter);
      const c6 = parseBRL(d.cartaoC6 ?? d.c6);
      const seguroCarro = parseBRL(d.seguroCarro);
      const saldoConta = parseBRL(d.saldoConta);
      const totalSaidas = inter + c6 + seguroCarro;
      const sobraSalario = salario - totalSaidas;
      const saldoFinal = saldoConta + sobraSalario;
      return { salario, inter, c6, seguroCarro, saldoConta, totalSaidas, sobraSalario, saldoFinal };
    }

    function updateKPIs(d){
      const c = calcFields(d);
      $("totalCartoes").textContent = brNum(c.totalSaidas);
      $("sobraSalario").textContent = brNum(c.sobraSalario);
      $("saldoFinal").textContent = brNum(c.saldoFinal);
      $("saldoFinal2").textContent = brNum(c.saldoFinal);

      if (c.sobraSalario >= 0) {
        $("quickHint").textContent = `Sobrou ${brl(c.sobraSalario)} do salário; somando com a conta, saldo final projeta ${brl(c.saldoFinal)}.`;
      } else {
        $("quickHint").textContent = `Saídas passaram ${brl(Math.abs(c.sobraSalario))} do salário; seu saldo final projeta ${brl(c.saldoFinal)}.`;
      }
    }

    function atualizarTabelaSalvos(d, updatedAtMillis = null){
      const c = calcFields(d);
      const tbody = $("dadosSalvosTabela");
      if (!tbody) return;

      const updatedText = updatedAtMillis ? new Date(updatedAtMillis).toLocaleString("pt-BR") : "-";
      const linhas = [
        ["Salário", brl(c.salario)],
        ["Cartão Inter", brl(c.inter)],
        ["Cartão C6", brl(c.c6)],
        ["Seguro Carro", brl(c.seguroCarro)],
        ["Saldo em Conta", brl(c.saldoConta)],
        ["Total Saídas", brl(c.totalSaidas)],
        ["Sobra do Salário", brl(c.sobraSalario)],
        ["Saldo Final Projetado", brl(c.saldoFinal)],
        ["Última Atualização", updatedText]
      ];

      tbody.innerHTML = "";
      linhas.forEach(([campo, valor]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:8px; border:1px solid #d8b79c;">${campo}</td>
          <td style="padding:8px; border:1px solid #d8b79c; font-weight:900;">${valor}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function setInputsFromDoc(d){
      safeSetInput("salario", d.salario);
      safeSetInput("inter", d.cartaoInter ?? d.inter);
      safeSetInput("c6", d.cartaoC6 ?? d.c6);
      safeSetInput("seguroCarro", d.seguroCarro);
      safeSetInput("saldoConta", d.saldoConta);

      updateKPIs(d);
      const updatedAtMillis = d?.updatedAt?.toMillis?.() ?? null;
      atualizarTabelaSalvos(d, updatedAtMillis);
    }

    function currentMonthId(){ return $("monthSelect").value; }
    function monthDocRef(monthId){ return doc(db, "users", uid, "months", monthId); }
    function mfaDocRef(){ return doc(db, "users", uid, "mfa", "customTotp"); }

    async function ensureMonthDocsExist(){
      for (const m of months){
        const ref = monthDocRef(m);
        const snap = await getDoc(ref);
        if (!snap.exists()){
          await setDoc(ref, {
            salario: 0, cartaoInter: 0, cartaoC6: 0, seguroCarro: 0, saldoConta: 0,
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
        }
      }
    }

    function rebuildChart(){
      const labels = months.map(m => monthNames[months.indexOf(m)].slice(0,3).toUpperCase());
      const salarios = months.map(m => calcFields(monthsData.get(m)).salario);
      const saidas = months.map(m => calcFields(monthsData.get(m)).totalSaidas);
      const saldoFinal = months.map(m => calcFields(monthsData.get(m)).saldoFinal);

      const ctx = $("chart");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [
          { label: "Salário", data: salarios, borderWidth: 1 },
          { label: "Saídas (Inter + C6 + Seguro)", data: saidas, borderWidth: 1 },
          { label: "Saldo Final Projetado", data: saldoFinal, type: "line", tension: 0.25, borderWidth: 2, pointRadius: 3, yAxisID: "y" }
        ]},
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${brl(ctx.parsed.y)}` } }
          },
          scales: { y: { ticks: { callback: (v) => brl(v) } } }
        }
      });
    }

    function listenAllMonths(){
      const colRef = collection(db, "users", uid, "months");
      unsubAllMonths = onSnapshot(colRef, (snap) => {
        snap.forEach(docSnap => {
          const monthId = docSnap.id;
          if (!monthsData.has(monthId)) return;
          const d = docSnap.data() || {};
          monthsData.set(monthId, {
            salario: parseBRL(d.salario),
            cartaoInter: parseBRL(d.cartaoInter),
            cartaoC6: parseBRL(d.cartaoC6),
            seguroCarro: parseBRL(d.seguroCarro),
            saldoConta: parseBRL(d.saldoConta)
          });
        });
        rebuildChart();
      });
    }

    function listenSelectedMonth(){
      if (unsubSelected) unsubSelected();

      const m = currentMonthId();
      $("monthTitle").textContent = monthNames[months.indexOf(m)];

      const ref = monthDocRef(m);
      unsubSelected = onSnapshot(ref, (snap) => {
        if (!snap.exists()){
          const empty = {salario:0, cartaoInter:0, cartaoC6:0, seguroCarro:0, saldoConta:0};
          setInputsFromDoc(empty);
          $("status").textContent = `Carregado: ${m} • (vazio)`;
          return;
        }
        const d = snap.data() || {};
        setInputsFromDoc(d);
        $("status").textContent = `Carregado: ${m} • Última atualização: ok`;
      });
    }

    async function saveCurrentMonthAuto(){
      if (!uid) return;
      const m = currentMonthId();
      const ref = monthDocRef(m);

      const payload = {
        salario: parseBRL($("salario").value),
        cartaoInter: parseBRL($("inter").value),
        cartaoC6: parseBRL($("c6").value),
        seguroCarro: parseBRL($("seguroCarro").value),
        saldoConta: parseBRL($("saldoConta").value),
        updatedAt: serverTimestamp()
      };

      if (autosaveInFlight) { pendingSaveAfter = true; return; }

      autosaveInFlight = true;
      try{
        $("status").textContent = "Salvando…";
        await setDoc(ref, payload, { merge: true });
        updateKPIs(payload);
        atualizarTabelaSalvos(payload, Date.now());
        $("status").textContent = `Salvo automaticamente: ${m}`;
      } catch (e){
        console.error(e);
        $("status").textContent = "Falha ao salvar. Verifique sua internet e tente novamente.";
      } finally {
        autosaveInFlight = false;
        if (pendingSaveAfter) { pendingSaveAfter = false; scheduleAutosave(); }
      }
    }

    function scheduleAutosave(){
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => saveCurrentMonthAuto(), 1500);
    }

    async function resetCurrentMonth(){
      const m = currentMonthId();
      const ref = monthDocRef(m);

      const payload = { salario:0, cartaoInter:0, cartaoC6:0, seguroCarro:0, saldoConta:0, updatedAt: serverTimestamp() };
      await setDoc(ref, payload, { merge: true });
      $("status").textContent = `Zerado: ${m}`;
      updateKPIs(payload);
      atualizarTabelaSalvos(payload, Date.now());
      ["salario","inter","c6","seguroCarro","saldoConta"].forEach(id => safeSetInput(id, 0));
    }

    $("monthSelect").addEventListener("change", () => listenSelectedMonth());
    $("resetBtn").addEventListener("click", resetCurrentMonth);

    const moneyFields = ["salario","inter","c6","seguroCarro","saldoConta"];
    moneyFields.forEach(id => {
      const el = $(id);
      el.addEventListener("focus", () => markEditing(el, true));
      el.addEventListener("input", () => {
        el.value = el.value.replace(/[^\d,.\-R$\s]/g, "");
        const draft = {
          salario: $("salario").value,
          cartaoInter: $("inter").value,
          cartaoC6: $("c6").value,
          seguroCarro: $("seguroCarro").value,
          saldoConta: $("saldoConta").value
        };
        updateKPIs(draft);
        atualizarTabelaSalvos(draft, null);
        scheduleAutosave();
      });
      el.addEventListener("blur", () => {
        markEditing(el, false);
        formatInputToBRL(el);
        saveCurrentMonthAuto();
      });
    });

    function formatAllInputsNow(){
      moneyFields.forEach(id => {
        const el = $(id);
        if (!el || !el.value || editing.has(id)) return;
        formatInputToBRL(el);
      });
    }

    // ====== TOTP manual (WebCrypto) ======
    const ISSUER = "Controle 2026 - Gastos";
    const SESSION_KEY = "mfa_verified_until_ms";

    function clearTotpUi(){
      $("secretKeyBox").textContent = "—";
      $("totpCode").value = "";
      $("mfaCode").value = "";
      const c = $("qrCanvas");
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
    }

    function base32Encode(bytes){
      const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
      let bits = 0, value = 0, output = "";
      for (const b of bytes){
        value = (value << 8) | b;
        bits += 8;
        while (bits >= 5){
          output += alphabet[(value >>> (bits - 5)) & 31];
          bits -= 5;
        }
      }
      if (bits > 0){
        output += alphabet[(value << (5 - bits)) & 31];
      }
      return output;
    }

    function base32Decode(str){
      const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
      const clean = str.replace(/=+$/,"").toUpperCase().replace(/[^A-Z2-7]/g,"");
      let bits = 0, value = 0;
      const out = [];
      for (const ch of clean){
        const idx = alphabet.indexOf(ch);
        if (idx < 0) continue;
        value = (value << 5) | idx;
        bits += 5;
        if (bits >= 8){
          out.push((value >>> (bits - 8)) & 255);
          bits -= 8;
        }
      }
      return new Uint8Array(out);
    }

    function toBigEndianCounter(counter){
      const buf = new ArrayBuffer(8);
      const view = new DataView(buf);
      const high = Math.floor(counter / 2**32);
      const low = counter >>> 0;
      view.setUint32(0, high);
      view.setUint32(4, low);
      return new Uint8Array(buf);
    }

    async function hotp(secretBytes, counter, digits=6){
      const key = await crypto.subtle.importKey(
        "raw",
        secretBytes,
        { name:"HMAC", hash:"SHA-1" },
        false,
        ["sign"]
      );
      const msg = toBigEndianCounter(counter);
      const sig = new Uint8Array(await crypto.subtle.sign("HMAC", key, msg));
      const offset = sig[sig.length - 1] & 0x0f;
      const bin =
        ((sig[offset] & 0x7f) << 24) |
        ((sig[offset+1] & 0xff) << 16) |
        ((sig[offset+2] & 0xff) << 8) |
        (sig[offset+3] & 0xff);
      const mod = bin % (10 ** digits);
      return String(mod).padStart(digits, "0");
    }

    async function totp(secretBase32, { period=30, digits=6, driftSteps=1 } = {}){
      const secretBytes = base32Decode(secretBase32);
      const nowSec = Math.floor(Date.now()/1000);
      const counter = Math.floor(nowSec / period);

      const codes = [];
      for (let d=-driftSteps; d<=driftSteps; d++){
        codes.push(await hotp(secretBytes, counter + d, digits));
      }
      return codes;
    }

    function makeOtpAuthUrl(email, secretBase32){
      const label = encodeURIComponent(`${ISSUER}:${email}`);
      const issuer = encodeURIComponent(ISSUER);
      const secret = encodeURIComponent(secretBase32);
      return `otpauth://totp/${label}?secret=${secret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
    }

    // ✅ QR fallback: se a lib não carregar, não trava. Usuário usa a CHAVE.
    function renderQrOrFallback(uri){
      return new Promise((resolve) => {
        const canvas = $("qrCanvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);

        const QR = window.QRCode;
        if (!QR){
          // desenha “QR indisponível”
          ctx.font = "12px Arial";
          ctx.fillStyle = "#6b5a4f";
          ctx.fillText("QR indisponível.", 35, 85);
          ctx.fillText("Use a chave ao lado.", 25, 105);
          resolve({ ok:false, reason:"QRCode lib não carregou" });
          return;
        }

        // tenta toCanvas (várias builds expõem isso)
        if (typeof QR.toCanvas === "function"){
          QR.toCanvas(canvas, uri, { width: 180, margin: 1 }, (err) => {
            if (err){
              ctx.font = "12px Arial";
              ctx.fillStyle = "#6b5a4f";
              ctx.fillText("Falha ao gerar QR.", 30, 85);
              ctx.fillText("Use a chave ao lado.", 25, 105);
              resolve({ ok:false, reason:String(err) });
            } else resolve({ ok:true });
          });
          return;
        }

        // fallback: algumas builds têm QRCode(canvas, text, cb) ou toDataURL
        try{
          if (typeof QR.toDataURL === "function"){
            QR.toDataURL(uri, { width: 180, margin: 1 }, (err, url) => {
              if (err || !url){
                ctx.font = "12px Arial";
                ctx.fillStyle = "#6b5a4f";
                ctx.fillText("Falha ao gerar QR.", 30, 85);
                ctx.fillText("Use a chave ao lado.", 25, 105);
                resolve({ ok:false, reason:String(err || "sem url") });
                return;
              }
              const img = new Image();
              img.onload = () => { ctx.drawImage(img, 0, 0, 180, 180); resolve({ ok:true }); };
              img.onerror = () => {
                ctx.font = "12px Arial";
                ctx.fillStyle = "#6b5a4f";
                ctx.fillText("Falha ao renderizar.", 30, 85);
                ctx.fillText("Use a chave ao lado.", 25, 105);
                resolve({ ok:false, reason:"img load fail" });
              };
              img.src = url;
            });
            return;
          }
        } catch(e){
          // ignore
        }

        ctx.font = "12px Arial";
        ctx.fillStyle = "#6b5a4f";
        ctx.fillText("QR indisponível.", 35, 85);
        ctx.fillText("Use a chave ao lado.", 25, 105);
        resolve({ ok:false, reason:"API QRCode não compatível" });
      });
    }

    function isSessionMfaValid(){
      const until = Number(sessionStorage.getItem(SESSION_KEY) || "0");
      return Date.now() < until;
    }
    function setSessionMfaValid(minutes=360){
      sessionStorage.setItem(SESSION_KEY, String(Date.now() + minutes*60*1000));
    }
    function clearSessionMfa(){
      sessionStorage.removeItem(SESSION_KEY);
    }

    async function loadCustomTotpConfig(){
      const ref = mfaDocRef();
      const snap = await getDoc(ref);
      if (!snap.exists()) return { enabled:false };
      return snap.data() || { enabled:false };
    }

    // ====== AUTH buttons ======
    $("btnLogin").addEventListener("click", async () => {
      try{
        $("loginStatus").textContent = "Entrando…";
        await signInWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPass").value);
      } catch(e){
        console.error(e);
        $("loginStatus").textContent = "Erro ao entrar: " + (e.code || e.message);
      }
    });

    $("btnRegister").addEventListener("click", async () => {
      try{
        $("loginStatus").textContent = "Criando conta…";
        const cred = await createUserWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPass").value);
        await sendEmailVerification(cred.user, { url: window.location.href, handleCodeInApp: false });
        $("loginStatus").textContent = "Enviado ✅ Verifique seu e-mail e depois faça login.";
        await signOut(auth);
      } catch(e){
        console.error(e);
        $("loginStatus").textContent = "Erro ao criar conta: " + (e.code || e.message);
      }
    });

    $("btnResendVerify").addEventListener("click", async () => {
      try{
        const email = $("loginEmail").value.trim();
        const pass = $("loginPass").value;
        if (!email || !pass){
          $("loginStatus").textContent = "Preencha e-mail e senha para reenviar a verificação.";
          return;
        }
        $("loginStatus").textContent = "Reenviando verificação…";
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await sendEmailVerification(cred.user, { url: window.location.href, handleCodeInApp: false });
        $("loginStatus").textContent = "Enviado ✅ Verifique seu e-mail e depois faça login.";
        await signOut(auth);
      } catch(e){
        console.error(e);
        $("loginStatus").textContent = "Erro ao reenviar: " + (e.code || e.message);
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      clearSessionMfa();
      await signOut(auth);
    });

    $("btnEnrollLogout").addEventListener("click", async () => {
      clearSessionMfa();
      await signOut(auth);
    });

    $("btnMfaBack").addEventListener("click", async () => {
      clearSessionMfa();
      await signOut(auth);
    });

    // ====== Manual TOTP enroll ======
    let pendingSecretBase32 = null;

    $("btnTotpGenerate").addEventListener("click", async () => {
      try{
        const user = auth.currentUser;
        if (!user) { showLogin("Faça login novamente."); return; }

        await reload(user);
        if (!user.emailVerified){
          $("enrollStatus").textContent = "Confirme seu e-mail antes de ativar o Authenticator (use Reenviar verificação).";
          return;
        }

        clearTotpUi();
        $("enrollStatus").textContent = "Gerando segredo…";

        const raw = crypto.getRandomValues(new Uint8Array(20)); // 160-bit
        pendingSecretBase32 = base32Encode(raw);

        const uri = makeOtpAuthUrl(user.email || "usuario", pendingSecretBase32);

        // sempre mostra a chave
        $("secretKeyBox").textContent = pendingSecretBase32;

        // tenta QR, mas se falhar não trava
        const qr = await renderQrOrFallback(uri);
        if (!qr.ok){
          $("enrollStatus").textContent = "QR indisponível neste navegador ✅ Use a CHAVE ao lado no Authenticator e digite o código.";
        } else {
          $("enrollStatus").textContent = "QR pronto ✅ Abra o Authenticator e digite o código.";
        }
      } catch(e){
        console.error(e);
        $("enrollStatus").textContent = "Erro ao gerar QR/segredo: " + (e.code || e.message);
      }
    });

    $("btnTotpVerify").addEventListener("click", async () => {
      try{
        const user = auth.currentUser;
        if (!user) { showLogin("Faça login novamente."); return; }

        const code = $("totpCode").value.trim();
        if (!pendingSecretBase32){
          $("enrollStatus").textContent = "Clique em Gerar QR primeiro.";
          return;
        }
        if (!/^\d{6}$/.test(code)){
          $("enrollStatus").textContent = "Digite um código válido de 6 dígitos.";
          return;
        }

        $("enrollStatus").textContent = "Validando…";
        const validCodes = await totp(pendingSecretBase32, { driftSteps: 1 });
        if (!validCodes.includes(code)){
          $("enrollStatus").textContent = "Código inválido. Tente novamente (confira o horário do celular).";
          return;
        }

        await setDoc(mfaDocRef(), {
          enabled: true,
          secretBase32: pendingSecretBase32,
          issuer: ISSUER,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        pendingSecretBase32 = null;
        setSessionMfaValid(360); // 6h nessa sessão

        $("enrollStatus").textContent = "Ativado ✅ Entrando…";
        await goToApp();
      } catch(e){
        console.error(e);
        $("enrollStatus").textContent = "Erro ao confirmar: " + (e.code || e.message);
      }
    });

    // ====== Manual TOTP challenge ======
    $("btnMfaVerify").addEventListener("click", async () => {
      try{
        const user = auth.currentUser;
        if (!user) { showLogin("Faça login novamente."); return; }

        const code = $("mfaCode").value.trim();
        if (!/^\d{6}$/.test(code)){
          $("mfaStatus").textContent = "Digite um código válido de 6 dígitos.";
          return;
        }

        $("mfaStatus").textContent = "Validando…";
        const cfg = await loadCustomTotpConfig();
        if (!cfg?.enabled || !cfg?.secretBase32){
          showEnroll("Você precisa ativar o Authenticator primeiro.");
          return;
        }

        const validCodes = await totp(cfg.secretBase32, { driftSteps: 1 });
        if (!validCodes.includes(code)){
          $("mfaStatus").textContent = "Código inválido. Confira o horário do celular e tente novamente.";
          return;
        }

        setSessionMfaValid(360); // 6h
        $("mfaStatus").textContent = "Ok ✅ Entrando…";
        await goToApp();
      } catch(e){
        console.error(e);
        $("mfaStatus").textContent = "Erro: " + (e.code || e.message);
      }
    });

    // ====== App init ======
    async function goToApp(){
      showApp();
      try{
        $("status").textContent = "Inicializando meses de 2026…";
        await ensureMonthDocsExist();
        $("status").textContent = "Pronto ✅";
        listenAllMonths();
        listenSelectedMonth();
        setTimeout(formatAllInputsNow, 50);
      } catch(e){
        console.error(e);
        $("status").textContent = "Erro ao carregar dados. Veja o console (F12).";
      }
    }

    // ====== Auth state ======
    onAuthStateChanged(auth, async (user) => {
      if (unsubAllMonths) { unsubAllMonths(); unsubAllMonths = null; }
      if (unsubSelected) { unsubSelected(); unsubSelected = null; }

      if (!user){
        uid = null;
        pendingSecretBase32 = null;
        clearTotpUi();
        clearSessionMfa();
        showLogin("Faça login para acessar seus dados.");
        return;
      }

      await reload(user);
      if (!user.emailVerified){
        uid = null;
        pendingSecretBase32 = null;
        clearTotpUi();
        clearSessionMfa();
        showLogin("Verifique seu e-mail (link de confirmação) e faça login novamente.");
        await signOut(auth);
        return;
      }

      uid = user.uid;

      const cfg = await loadCustomTotpConfig();
      if (!cfg?.enabled){
        pendingSecretBase32 = null;
        clearTotpUi();
        showEnroll("Ative o Authenticator para continuar.");
        return;
      }

      if (isSessionMfaValid()){
        await goToApp();
        return;
      }

      $("mfaCode").value = "";
      showMfa("Digite o código do Authenticator.");
    });

    // start
    showLogin("Verificando sessão…");
  </script>
</body>
</html>
